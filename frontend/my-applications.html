<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications - TalentLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .applications-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        
        .applications-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .applications-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }
        
        .applications-header p {
            font-size: 1.1rem;
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .application-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .application-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1.5rem;
        }
        
        .application-info {
            flex: 1;
        }
        
        .job-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .job-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .job-title a:hover {
            color: #1976d2;
        }
        
        .company-name {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .company-location {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: #6c757d;
            font-size: 0.95rem;
            margin-top: 0.3rem;
        }
        
        .application-date {
            font-size: 0.9rem;
            color: #868e96;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
        }
        
        .status-badge i {
            font-size: 1rem;
        }
        
        .status-applied {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-applied i {
            color: #1976d2;
        }
        
        .status-under_review {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-under_review i {
            color: #f57c00;
        }
        
        .status-interview {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .status-interview i {
            color: #388e3c;
        }
        
        .status-offer {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 700;
        }
        
        .status-offer i {
            color: #2e7d32;
        }
        
        .status-rejected {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .status-rejected i {
            color: #d32f2f;
        }
        
        .status-withdrawn {
            background-color: #f5f5f5;
            color: #616161;
        }
        
        .status-withdrawn i {
            color: #616161;
        }
        
        .status-accepted {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-accepted i {
            color: #2e7d32;
        }
        
        .application-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
            padding: 1.5rem 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        
        .application-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .meta-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background-color: #f8f9fa;
            color: #495057;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .meta-tag i {
            font-size: 1rem;
            color: #6c757d;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .detail-item .material-icons {
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .detail-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .detail-value {
            color: #1a1a1a;
            font-size: 0.9rem;
        }
        
                 .application-actions {
             display: flex;
             gap: 1rem;
             margin-top: 1.5rem;
             flex-wrap: wrap;
             justify-content: flex-start;
             align-items: center;
             padding-top: 1rem;
             border-top: 1px solid #e9ecef;
         }
         
         .action-group {
             display: flex;
             gap: 0.75rem;
             align-items: center;
         }
         
         .action-divider {
             width: 1px;
             height: 2rem;
             background-color: #e9ecef;
             margin: 0 0.5rem;
         }
        
        .application-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #e9ecef;
        }
        
        .application-card.status-applied::before {
            background-color: #1976d2;
        }
        
        .application-card.status-under_review::before {
            background-color: #f57c00;
        }
        
        .application-card.status-interview::before {
            background-color: #388e3c;
        }
        
        .application-card.status-offer::before {
            background-color: #2e7d32;
        }
        
        .application-card.status-rejected::before,
        .application-card.status-withdrawn::before {
            background-color: #d32f2f;
        }
        
                 .btn-view-job {
             background: linear-gradient(135deg, #4a6cf7 0%, #3b5bdb 100%);
             color: white;
             border: none;
             padding: 0.875rem 1.75rem;
             border-radius: 8px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             text-decoration: none;
             display: inline-flex;
             align-items: center;
             gap: 0.5rem;
             transition: all 0.3s ease;
             box-shadow: 0 2px 8px rgba(74, 108, 247, 0.25);
             position: relative;
             overflow: hidden;
             min-width: 160px;
             justify-content: center;
         }
         
         .btn-view-job .material-icons {
             color: white;
         }
         
         .btn-view-job:hover {
             background: linear-gradient(135deg, #3b5bdb 0%, #274bb6 100%);
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(74, 108, 247, 0.35);
             color: white;
         }
         
         .btn-view-job:hover .material-icons {
             color: white;
         }
         
         .btn-view-job:active {
             transform: translateY(0);
             box-shadow: 0 2px 8px rgba(74, 108, 247, 0.25);
         }
         
         .btn-withdraw {
             background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
             color: #dc3545;
             border: 2px solid #dc3545;
             padding: 0.875rem 1.75rem;
             border-radius: 8px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: inline-flex;
             align-items: center;
             gap: 0.5rem;
             box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
             position: relative;
             overflow: hidden;
             min-width: 160px;
             justify-content: center;
         }
         
         .btn-withdraw:hover {
             background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3);
             border-color: #dc3545;
         }
         
         .btn-withdraw:active {
             transform: translateY(0);
             box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
         }
         
         .btn-withdraw:disabled {
             background: #f8f9fa;
             color: #6c757d;
             border-color: #dee2e6;
             cursor: not-allowed;
             transform: none;
             box-shadow: none;
         }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .empty-state .material-icons {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }
        
        .empty-state p {
            color: #6c757d;
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6cf7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
                 @media (max-width: 768px) {
             .application-header {
                 flex-direction: column;
                 align-items: flex-start;
             }
             
             .status-badge {
                 align-self: flex-start;
             }
             
             .application-details {
                 grid-template-columns: 1fr;
             }
             
             .application-actions {
                 flex-direction: column;
                 gap: 1rem;
             }
             
             .action-group {
                 width: 100%;
             }
             
             .action-divider {
                 display: none;
             }
             
             .btn-view-job, .btn-withdraw {
                 width: 100%;
                 justify-content: center;
                 padding: 1rem 1.5rem;
             }
             
             .application-meta {
                 flex-direction: column;
                 gap: 0.5rem;
             }
             
             .meta-tag {
                 width: fit-content;
             }
         }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">TalentLink</a>
            <div class="nav-links" id="navLinks">
                <a href="index.html">Home</a>
                <a href="jobs.html">Jobs</a>
                <a href="#companies">Companies</a>
                <a href="my-applications.html" id="applicationsLink" class="active">Your Applications</a>
                <!-- Post a Job Button - Only visible to employers -->
                <a href="post-job.html" class="btn btn-primary" id="postJobBtn" style="display: none; margin-left: 10px;">
                    <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</i>
                    Post a Job
                </a>
                <!-- Auth State Container - Will be managed by auth.js -->
                <div id="authState">
                    <!-- Login/Signup Buttons (Shown when not logged in) -->
                    <div class="auth-buttons" id="authButtons">
                        <a href="login.html" class="btn btn-outline" id="loginLink">Login</a>
                        <a href="signup.html" class="btn btn-primary" id="registerLink">Sign Up</a>
                    </div>
                    <!-- User Menu (Shown when logged in) -->
                    <div class="user-menu" id="userMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="user-avatar" id="userAvatar">
                                <span class="material-icons">account_circle</span>
                                <span id="userInitials" class="user-initials"></span>
                            </button>
                            <div class="dropdown-content" id="dropdownMenu">
                                <div class="user-info">
                                    <div id="userName" class="user-name">Loading...</div>
                                    <div id="userEmail" class="user-email"></div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <a href="profile.html"><i class="material-icons">person</i> My Profile</a>
                                <a href="my-jobs.html"><i class="material-icons">work</i> My Jobs</a>
                                <a href="settings.html"><i class="material-icons">settings</i> Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" id="logoutBtn"><i class="material-icons">logout</i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false" aria-controls="navLinks">
                <span class="material-icons">menu</span>
            </button>
        </div>
    </nav>

    <main class="container" style="margin-top: 6rem;">
        <div class="applications-container">
            <div class="applications-header">
                <h1>My Applications</h1>
                <p>Track the status of your job applications and stay updated on your career progress.</p>
            </div>
            
            <div id="applicationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your applications...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3>TalentLink</h3>
                    <p>Connecting top talent with leading companies worldwide. Find your dream job or your next great hire today.</p>
                </div>
                <div class="footer-links">
                    <h4>For Job Seekers</h4>
                    <a href="jobs.html">Browse Jobs</a>
                    <a href="profile.html">Create Profile</a>
                    <a href="#">Career Resources</a>
                </div>
                <div class="footer-links">
                    <h4>For Employers</h4>
                    <a href="post-job.html">Post a Job</a>
                    <a href="#">Browse Candidates</a>
                    <a href="#">Pricing</a>
                </div>
                <div class="footer-links">
                    <h4>Company</h4>
                    <a href="#">About Us</a>
                    <a href="#">Contact</a>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TalentLink. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('navLinks');
        
        if (hamburger && navLinks) {
            hamburger.addEventListener('click', function() {
                navLinks.classList.toggle('active');
                this.setAttribute('aria-expanded', this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
            });
        }
        
        // Close mobile menu when clicking on a nav link
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    navLinks.classList.remove('active');
                    hamburger.setAttribute('aria-expanded', 'false');
                }
            });
        });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const api = new ApiService();
        // Update applications link text based on user type
        function updateApplicationsLink() {
            const applicationsLink = document.getElementById('applicationsLink');
            if (applicationsLink && window.TalentLink?.auth) {
                const isEmployer = window.TalentLink.auth.isEmployer();
                applicationsLink.textContent = isEmployer ? 'Applications' : 'My Applications';
            }
        }
        
        // Update on auth state change
        window.addEventListener('authStateChange', updateApplicationsLink);
        
        // Initial update
        setTimeout(updateApplicationsLink, 100);
        
        // Wait for auth system to initialize
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const applicationsList = document.getElementById('applicationsList');
        
        // Check if user is logged in
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        console.log('Auth check:', { token: !!token, user: user });
        
        if (!token || !user.id) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">lock</i>
                    <h3>Please Log In</h3>
                    <p>You need to be logged in to view your applications.</p>
                    <a href="login.html" class="btn btn-primary">Login</a>
                </div>
            `;
            return;
        }
        
        // Check if user is a candidate (only candidates should see their applications)
        const isCandidate = user.user_type === 'candidate' || user.user_type === 'job_seeker';
        const isEmployer = user.user_type === 'company' || user.user_type === 'employer';
        if (isEmployer) {
            // Redirect employers to their dedicated page
            window.location.href = 'all-applications.html';
            return;
        }
        if (!isCandidate) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">work</i>
                    <h3>Access Denied</h3>
                    <p>This page is for job seekers to view their applications.</p>
                    <a href="jobs.html" class="btn btn-primary">Browse Jobs</a>
                </div>
            `;
            return;
        }
        
        try {
            console.log('Loading user applications...');
            console.log('API service available:', !!window.TalentLink?.api);
            console.log('Jobs API available:', !!window.TalentLink?.api?.jobs);
            console.log('getMyApplications method available:', !!window.TalentLink?.api?.jobs?.getMyApplications);
            
            if (!window.TalentLink?.api) {
                throw new Error('API service not available');
            }
            
            if (!window.TalentLink?.api?.jobs) {
                throw new Error('Jobs API not available');
            }
            
            if (!window.TalentLink?.api?.jobs?.getMyApplications) {
                throw new Error('getMyApplications method not available');
            }
            
            // Load user's applications with cache busting
            const applications = await window.TalentLink.api.request('GET', 
                `/api/job-applications/?_=${Date.now()}`);
                
            console.log('Applications loaded:', applications);
            
            // Ensure applications is an array
            let applicationsArray = [];
            if (Array.isArray(applications)) {
                applicationsArray = applications;
            } else if (applications && applications.results && Array.isArray(applications.results)) {
                applicationsArray = applications.results;
            } else if (applications && applications.data && Array.isArray(applications.data)) {
                applicationsArray = applications.data;
            } else {
                console.warn('Applications is not an array or doesn\'t contain expected data structure:', applications);
                applicationsArray = [];
            }
            
            console.log('Applications array:', applicationsArray);
            
            if (!applicationsArray || applicationsArray.length === 0) {
                applicationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">description</i>
                        <h3>No Applications Yet</h3>
                        <p>You haven't applied to any jobs yet. Start your job search and apply to positions that match your skills.</p>
                        <a href="jobs.html" class="btn btn-primary">Browse Jobs</a>
                    </div>
                `;
                return;
            }
            
            // Helper function to format status
            const formatStatus = (status) => {
                const statusMap = {
                    'applied': { label: 'Applied', icon: 'send' },
                    'under_review': { label: 'Under Review', icon: 'hourglass_empty' },
                    'interview': { label: 'Interview', icon: 'video_call' },
                    'offer': { label: 'Offer Received', icon: 'card_giftcard' },
                    'accepted': { label: 'Accepted', icon: 'check_circle' },
                    'rejected': { label: 'Not Selected', icon: 'cancel' },
                    'withdrawn': { label: 'Withdrawn', icon: 'undo' }
                };
                return statusMap[status] || { label: status.replace('_', ' '), icon: 'info' };
            };
            
            // Helper function to format job type
            const formatJobType = (jobType) => {
                const jobTypeMap = {
                    'full_time': 'Full Time',
                    'part_time': 'Part Time',
                    'contract': 'Contract',
                    'internship': 'Internship',
                    'remote': 'Remote'
                };
                return jobTypeMap[jobType] || jobType;
            };

            // Render applications
            applicationsList.innerHTML = applicationsArray.map(application => {
                const statusInfo = formatStatus(application.status);
                const appliedDate = new Date(application.applied_at);
                const updatedDate = new Date(application.updated_at);
                const isActive = !['rejected', 'withdrawn', 'accepted'].includes(application.status);
                
                return `
                <div class="application-card status-${application.status}">
                    <div class="application-header">
                        <div class="application-info">
                            <h3 class="job-title">
                                <a href="job-details.html?id=${application.job_posting}">
                                    ${application.job_title || 'Job Title Not Available'}
                                </a>
                            </h3>
                            <div class="company-name">
                                <i class="material-icons">business</i>
                                ${application.company_name || 'Company Not Available'}
                            </div>
                            ${application.location ? `
                            <div class="company-location">
                                <i class="material-icons">location_on</i>
                                ${application.location}
                            </div>` : ''}
                            
                            <div class="application-meta">
                                <span class="meta-tag">
                                    <i class="material-icons">event</i>
                                    Applied: ${appliedDate.toLocaleDateString()}
                                </span>
                                ${application.job_type ? `
                                <span class="meta-tag">
                                    <i class="material-icons">work</i>
                                    ${formatJobType(application.job_type)}
                                </span>` : ''}
                                ${application.salary ? `
                                <span class="meta-tag">
                                    <i class="material-icons">payments</i>
                                    ${application.salary}
                                </span>` : ''}
                            </div>
                        </div>
                        
                        <div class="status-badge status-${application.status}">
                            <i class="material-icons">${statusInfo.icon}</i>
                            ${statusInfo.label}
                        </div>
                    </div>
                    
                    <div class="application-details">
                        <div class="detail-item">
                            <i class="material-icons">update</i>
                            <div>
                                <div class="detail-label">Last Updated</div>
                                <div class="detail-value">${updatedDate.toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="material-icons">schedule</i>
                            <div>
                                <div class="detail-label">Status</div>
                                <div class="detail-value">${statusInfo.label}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="material-icons">calendar_today</i>
                            <div>
                                <div class="detail-label">Applied On</div>
                                <div class="detail-value">${appliedDate.toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="application-actions">
                        <div class="action-group">
                            <a href="job-details.html?id=${application.job_posting}" class="btn-view-job">
                                <i class="material-icons">work_outline</i>
                                View Job Details
                            </a>
                        </div>
                        
                        ${isActive ? `
                        <div class="action-divider"></div>
                        <div class="action-group">
                            <button class="btn-withdraw" onclick="withdrawApplication('${application.id}')">
                                <i class="material-icons">close</i>
                                Withdraw Application
                            </button>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');
            
        } catch (error) {
            console.error('Error loading applications:', error);
            console.error('Error details:', {
                message: error.message,
                status: error.status,
                response: error.response
            });
            
            let errorMessage = 'There was an error loading your applications. Please try again later.';
            if (error.response && error.response.data && error.response.data.detail) {
                errorMessage = error.response.data.detail;
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">error_outline</i>
                    <h3>Error Loading Applications</h3>
                    <p>${errorMessage}</p>
                    <button onclick="location.reload()" class="btn btn-primary">Retry</button>
                </div>
            `;
        }
    });
    
    // Function to withdraw application
    async function withdrawApplication(applicationId) {
        if (!confirm('Are you sure you want to withdraw this application? This action cannot be undone.')) {
            return;
        }
        
        // Show loading state
        const applicationCard = document.querySelector(`[data-application-id="${applicationId}"]`);
        if (applicationCard) {
            applicationCard.style.opacity = '0.6';
            applicationCard.style.pointerEvents = 'none';
            
            const withdrawButton = applicationCard.querySelector('.btn-withdraw');
            if (withdrawButton) {
                withdrawButton.disabled = true;
                withdrawButton.innerHTML = '<i class="material-icons" style="font-size: 16px; margin-right: 5px;">hourglass_empty</i> Withdrawing...';
            }
        }
        
        try {
            // Add cache-busting parameter
            await window.TalentLink.api.request('DELETE', `/api/job-applications/${applicationId}/?_=${Date.now()}`);
            
            // Clear job caches to ensure fresh data
            if (window.TalentLink && window.TalentLink.jobs && typeof window.TalentLink.jobs.clearJobCaches === 'function') {
                window.TalentLink.jobs.clearJobCaches();
            } else {
                // Fallback if the jobs module isn't available
                localStorage.setItem('jobListingsUpdated', Date.now().toString());
            }
            
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success';
            successMessage.style.position = 'fixed';
            successMessage.style.top = '20px';
            successMessage.style.right = '20px';
            successMessage.style.zIndex = '1000';
            successMessage.innerHTML = `
                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">check_circle</i>
                Application withdrawn successfully
            `;
            document.body.appendChild(successMessage);
            
            // Remove the application card from the UI
            if (applicationCard) {
                applicationCard.style.transition = 'all 0.3s ease';
                applicationCard.style.maxHeight = applicationCard.offsetHeight + 'px';
                applicationCard.style.margin = '0';
                applicationCard.style.padding = '0';
                applicationCard.style.opacity = '0';
                
                setTimeout(() => {
                    applicationCard.remove();
                    
                    // Check if there are no more applications
                    const remainingApplications = document.querySelectorAll('.application-card');
                    if (remainingApplications.length === 0) {
                        const applicationsList = document.getElementById('applicationsList');
                        if (applicationsList) {
                            applicationsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="material-icons">description</i>
                                    <h3>No Applications</h3>
                                    <p>You haven't applied to any jobs yet. Start your job search and apply to positions that match your skills.</p>
                                    <a href="jobs.html" class="btn btn-primary">Browse Jobs</a>
                                </div>
                            `;
                        }
                    }
                }, 300);
            }
            
            // Update the job listings to show this job as available again
            await updateJobListings(applicationId);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                successMessage.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(successMessage);
                }, 300);
            }, 3000);
            
        } catch (error) {
            console.error('Error withdrawing application:', error);
            
            // Reset UI state
            if (applicationCard) {
                applicationCard.style.opacity = '1';
                applicationCard.style.pointerEvents = 'auto';
                
                const withdrawButton = applicationCard.querySelector('.btn-withdraw');
                if (withdrawButton) {
                    withdrawButton.disabled = false;
                    withdrawButton.innerHTML = '<i class="material-icons" style="font-size: 16px; margin-right: 5px;">undo</i> Withdraw';
                }
            }
            
            // Show error message
            alert('Failed to withdraw application. Please try again.');
        }
    }
    
    // Function to update job listings after withdrawal
    async function updateJobListings(applicationId) {
        try {
            // Get the application details to find the job ID with cache busting
            const application = await window.TalentLink.api.request('GET', 
                `/api/job-applications/${applicationId}/?_=${Date.now()}`, 
                null, 
                { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' });
                
            if (!application || !application.job) {
                console.error('Invalid application data received:', application);
                return;
            }
            
            const jobId = application.job;
            
            // Get the job details with cache busting
            const job = await window.TalentLink.api.request('GET', 
                `/api/jobs/${jobId}/?_=${Date.now()}`,
                null,
                { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' });
                
            if (!job || !job.id) {
                console.error('Invalid job data received:', job);
                return;
            }
            
            console.log('Updating job listings for job ID:', jobId);
            
            // Update the job card in all listings
            updateJobCardInListings(job);
            
            // Force refresh the job listings in other tabs
            if (typeof(Storage) !== 'undefined') {
                try {
                    localStorage.setItem('jobListingsUpdated', Date.now());
                    console.log('Job listings update event triggered');
                } catch (e) {
                    console.error('Error updating localStorage:', e);
                }
            }
            
            // Also update the job listings in the current tab
            updateJobListingsInCurrentTab(job);
            
        } catch (error) {
            console.error('Error updating job listings:', error);
        }
    }
    
    // Function to update job listings in the current tab
    function updateJobListingsInCurrentTab(job) {
        // This function will be called to update job listings in the current tab
        // We'll implement this in the next step
        console.log('Updating job listings in current tab for job ID:', job.id);
        
        // Find and update the job card in the jobs list
        const jobCards = document.querySelectorAll('.job-card');
        jobCards.forEach(card => {
            const cardJobId = card.getAttribute('data-job-id');
            if (cardJobId === job.id.toString()) {
                // Update the apply button
                const applyButton = card.querySelector('.btn-apply');
                if (applyButton) {
                    applyButton.disabled = false;
                    applyButton.textContent = 'Apply Now';
                    applyButton.classList.remove('applied');
                    
                    // Remove any existing 'applied' badges
                    const appliedBadges = card.querySelectorAll('.applied-badge');
                    appliedBadges.forEach(badge => badge.remove());
                }
            }
        });
    }
    
    // Listen for storage events to update UI when data changes in other tabs
    if (typeof(Storage) !== 'undefined') {
        window.addEventListener('storage', function(event) {
            if (event.key === 'jobListingsUpdated') {
                // Reload the page to get fresh data
                location.reload();
            }
        });
    }
    
    // Function to update job card in all listings
    function updateJobCardInListings(job) {
        // Find and update the job card in the 'Latest Job Openings' section
        const latestJobsContainer = document.querySelector('#latest-jobs .jobs-grid');
        if (latestJobsContainer) {
            const jobCard = latestJobsContainer.querySelector(`[data-job-id="${job.id}"]`);
            if (jobCard) {
                // Remove the 'Applied' badge if it exists
                const appliedBadge = jobCard.querySelector('.applied-badge');
                if (appliedBadge) {
                    appliedBadge.remove();
                }
                
                // Enable the apply button if it was disabled
                const applyButton = jobCard.querySelector('.btn-apply');
                if (applyButton) {
                    applyButton.disabled = false;
                    applyButton.textContent = 'Apply Now';
                    applyButton.classList.remove('applied');
                }
            }
        }
        
        // Find and update the job card in the 'All Job Openings' section
        const allJobsContainer = document.querySelector('#all-jobs .jobs-grid');
        if (allJobsContainer) {
            const jobCard = allJobsContainer.querySelector(`[data-job-id="${job.id}"]`);
            if (jobCard) {
                // Remove the 'Applied' badge if it exists
                const appliedBadge = jobCard.querySelector('.applied-badge');
                if (appliedBadge) {
                    appliedBadge.remove();
                }
                
                // Enable the apply button if it was disabled
                const applyButton = jobCard.querySelector('.btn-apply');
                if (applyButton) {
                    applyButton.disabled = false;
                    applyButton.textContent = 'Apply Now';
                    applyButton.classList.remove('applied');
                }
            }
        }
    }
    </script>
</body>
</html> 