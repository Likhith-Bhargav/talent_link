<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Applications - TalentLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/all-applications.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">TalentLink</a>
            <div class="nav-links" id="navLinks">
                <a href="index.html">Home</a>
                <a href="jobs.html">Jobs</a>
                <a href="#companies">Companies</a>
                <a href="all-applications.html" id="applicationsLink" class="active">Applications</a>
                <a href="post-job.html" class="btn btn-primary" id="postJobBtn">
                    <i class="material-icons">add</i>
                    Post a Job
                </a>
                <div id="authState"></div>
            </div>
            <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false" aria-controls="navLinks">
                <span class="material-icons">menu</span>
            </button>
        </div>
    </nav>
    <main class="container" style="margin-top: 6rem;">
        <div class="applications-container">
            <div class="applications-header">
                <h1>All Applications</h1>
                <p>View all jobs posted by your company and see how many candidates have applied.</p>
            </div>
            <div id="applicationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your posted jobs...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Applicants Modal -->
    <div id="applicantsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Applicants</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="applicantsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading applicants...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3>TalentLink</h3>
                    <p>Connecting top talent with leading companies worldwide. Find your dream job or your next great hire today.</p>
                </div>
                <div class="footer-links">
                    <h4>For Job Seekers</h4>
                    <a href="jobs.html">Browse Jobs</a>
                    <a href="profile.html">Create Profile</a>
                    <a href="#">Career Resources</a>
                </div>
                <div class="footer-links">
                    <h4>For Employers</h4>
                    <a href="post-job.html">Post a Job</a>
                    <a href="#">Browse Candidates</a>
                    <a href="#">Pricing</a>
                </div>
                <div class="footer-links">
                    <h4>Company</h4>
                    <a href="#">About Us</a>
                    <a href="#">Contact</a>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TalentLink. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM fully loaded, initializing application...');
        
        // Initialize API service
        const api = window.TalentLink?.api || new ApiService();
        if (window.TalentLink) {
            window.TalentLink.api = api;
        }
        
        // Get token and user info
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const applicationsList = document.getElementById('applicationsList');
        
        // Debug info
        console.log('Debug - Token exists:', !!token);
        console.log('Debug - User object:', user);
        console.log('Debug - API Service available:', !!api);
        
        // Check authentication and role
        if (!token || !user.id) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">lock</i>
                    <h3>Authentication Required</h3>
                    <p>You need to be logged in to view this page.</p>
                    <a href="login.html" class="btn btn-primary">Login</a>
                </div>
            `;
            return;
        }
        
        // Check if user is an employer
        if (!(user.user_type === 'company' || user.user_type === 'employer')) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">block</i>
                    <h3>Access Denied</h3>
                    <p>This page is only accessible to employers.</p>
                    <a href="index.html" class="btn btn-primary">Return to Home</a>
                </div>
            `;
            return;
        }
        
        // Set the token for API calls
        api.setToken(token);
        
        // Add a small delay to ensure everything is properly initialized
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            console.log('Debug - Loading employer jobs...');
            
            // Use the backend endpoint that works based on the logged-in user
            const jobsResponse = await api.jobs.getMyCompanyJobs();
            console.log('Debug - API Response:', jobsResponse);
            
            const jobs = jobsResponse.results || [];
            console.log('Debug - Jobs loaded:', jobs);
            
            if (!jobs || jobs.length === 0) {
                applicationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">work_outline</i>
                        <h3>No Jobs Posted Yet</h3>
                        <p>You haven't posted any jobs yet. Start by posting a new job to see applications here.</p>
                        <a href="post-job.html" class="btn btn-primary">Post a Job</a>
                    </div>
                `;
                return;
            }
            
            applicationsList.innerHTML = jobs.map(job => `
                <div class="application-card">
                    <div class="application-header">
                        <div class="application-info">
                            <h3 class="job-title">
                                <a href="job-details.html?id=${job.id}">${job.title}</a>
                            </h3>
                            <div class="company-name">
                                <i class="material-icons">business</i>
                                ${job.company_name || 'Company'}
                            </div>
                            <div class="application-meta">
                                <span class="meta-tag">
                                    <i class="material-icons">event</i>
                                    Posted: ${new Date(job.created_at).toLocaleDateString()}
                                </span>
                                <span class="meta-tag">
                                    <i class="material-icons">work</i>
                                    ${job.job_type}
                                </span>
                            </div>
                        </div>
                        <div class="status-badge">
                            <i class="material-icons">group</i>
                            ${job.applicant_count} Applicants
                        </div>
                    </div>
                    <div class="application-actions">
                        <button class="btn btn-primary btn-view-applicants" data-job-id="${job.id}" data-job-title="${job.title}">
                            <i class="material-icons">visibility</i> View Applicants
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Event delegation is now handled in the DOMContentLoaded listener
        } catch (error) {
            console.error('Error loading jobs:', error);
            applicationsList.innerHTML = `<div class="empty-state"><i class="material-icons">error</i><h3>Error</h3><p>Could not load your jobs. Error: ${error.message}</p></div>`;
        }
    });

    // Modal functionality
    const modal = document.getElementById('applicantsModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeBtn = document.querySelector('.close');
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Close modal when clicking the close button
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Event delegation for View Applicants buttons
        document.addEventListener('click', async (event) => {
            const button = event.target.closest('.btn-view-applicants');
            if (!button) return;
            
            event.preventDefault();
            const jobId = button.dataset.jobId;
            const jobTitle = button.dataset.jobTitle;
            
            if (!jobId || !jobTitle) {
                console.error('Missing job ID or title');
                return;
            }
            
            try {
                await showApplicantsModal(jobId, jobTitle);
            } catch (error) {
                console.error('Error showing applicants modal:', error);
                showToast('Failed to load applicants. Please try again.', 'error');
            }
        });
    });
    
    // Function to generate applicant card HTML
    function generateApplicantCard(application) {
        const applicant = application.applicant || {};
        const job = application.job || {};
        const resume = application.resume || {};
        
        // Format application date
        const appDate = new Date(application.applied_at);
        const formattedDate = appDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        
        // Get initials for avatar
        const nameParts = applicant.full_name ? applicant.full_name.split(' ') : [];
        const initials = nameParts.length > 0 
            ? nameParts[0].charAt(0) + (nameParts[1] ? nameParts[1].charAt(0) : '')
            : '??';
        
        // Status badge class
        const statusClass = application.status ? `status-${application.status.toLowerCase().replace(' ', '_')}` : 'status-applied';
        const statusText = application.status ? application.status.replace('_', ' ') : 'Applied';
        
        // Skills list (max 5 skills)
        const skills = resume.skills ? 
            resume.skills.split(',').slice(0, 5).map(skill => 
                `<span class="skill-tag">${skill.trim()}</span>`
            ).join('') : '';
        
        // Experience text
        const experienceText = resume.experience_years ? 
            `${resume.experience_years} ${resume.experience_years > 1 ? 'years' : 'year'} exp` : '';
        
        return `
            <div class="applicant-card" data-application-id="${application.id}">
                <!-- Applicant Header -->
                <div class="applicant-header">
                    <div class="avatar">
                        <div class="avatar-initials">${initials}</div>
                    </div>
                    <div class="applicant-info">
                        <div class="applicant-name-row">
                            <h4 class="applicant-name">${applicant.full_name || 'Applicant'}</h4>
                            <span class="applicant-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="applicant-meta">
                            <span class="meta-item">
                                <i class="bi bi-envelope"></i>
                                ${applicant.email || 'No email'}
                            </span>
                            ${applicant.phone_number ? `
                                <span class="meta-item">
                                    <i class="bi bi-telephone"></i>
                                    ${applicant.phone_number}
                                </span>
                            ` : ''}
                            ${experienceText ? `
                                <span class="meta-item">
                                    <i class="bi bi-briefcase"></i>
                                    ${experienceText}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Skills Section -->
                ${skills ? `
                    <div class="card-section">
                        <div class="section-title">
                            <i class="bi bi-award"></i>
                            <span>Skills</span>
                        </div>
                        <div class="skills-container">
                            ${skills}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Cover Letter -->
                ${application.cover_letter ? `
                    <div class="card-section">
                        <div class="section-title">
                            <i class="bi bi-chat-square-text"></i>
                            <span>Cover Letter</span>
                        </div>
                        <div class="cover-letter-content">
                            ${application.cover_letter}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Resume -->
                ${resume.resume_file ? `
                    <div class="card-section">
                        <div class="section-title">
                            <i class="bi bi-file-earmark-pdf"></i>
                            <span>Resume</span>
                        </div>
                        <a href="${resume.resume_file}" target="_blank" class="btn btn-outline">
                            <i class="bi bi-eye"></i> View Resume
                        </a>
                    </div>
                ` : ''}
                
                <!-- Quick Actions -->
                <div class="card-section">
                    <div class="section-title">
                        <i class="bi bi-lightning"></i>
                        <span>Quick Actions</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-outline" data-action="email" data-applicant-id="${applicant.id}">
                            <i class="bi bi-envelope"></i> Email
                        </button>
                        <button class="btn btn-outline" data-action="schedule" data-applicant-id="${applicant.id}">
                            <i class="bi bi-calendar-plus"></i> Schedule
                        </button>
                        <button class="btn btn-outline" data-action="reject" data-application-id="${application.id}">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </div>
                </div>
                
                <!-- Status Update -->
                <div class="card-section">
                    <div class="section-title">
                        <i class="bi bi-arrow-repeat"></i>
                        <span>Update Status</span>
                    </div>
                    <div class="status-options">
                        <div class="status-option ${application.status === 'applied' ? 'active' : ''}" data-status="applied">
                            <i class="bi bi-send"></i>
                            <span>Applied</span>
                        </div>
                        <div class="status-option ${application.status === 'under_review' ? 'active' : ''}" data-status="under_review">
                            <i class="bi bi-search"></i>
                            <span>Review</span>
                        </div>
                        <div class="status-option ${application.status === 'interview' ? 'active' : ''}" data-status="interview">
                            <i class="bi bi-camera-video"></i>
                            <span>Interview</span>
                        </div>
                        <div class="status-option status-accept ${application.status === 'accepted' ? 'active' : ''}" data-status="accepted">
                            <i class="bi bi-check-circle"></i>
                            <span>Hire</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Function to set up event listeners for applicant cards
    function setupApplicantCardInteractions(modal, applications) {
        const container = modal.querySelector('#applicantsContainer');
        
        // Handle status updates
        container.addEventListener('click', function(e) {
            const statusOption = e.target.closest('.status-option');
            if (statusOption) {
                e.preventDefault();
                const card = statusOption.closest('.applicant-card');
                const applicationId = card.closest('[data-application-id]').getAttribute('data-application-id');
                const newStatus = statusOption.getAttribute('data-status');
                
                // Update UI immediately for better UX
                const statusBadge = card.querySelector('.applicant-status');
                statusBadge.className = `applicant-status status-${newStatus}`;
                statusBadge.textContent = newStatus.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Update active state
                card.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('active'));
                statusOption.classList.add('active');
                
                // Update the application status in the backend
                updateApplicationStatus(applicationId, newStatus);
            }
            
            // Handle quick actions
            const actionBtn = e.target.closest('[data-action]');
            if (actionBtn) {
                e.preventDefault();
                const action = actionBtn.getAttribute('data-action');
                const applicationId = actionBtn.getAttribute('data-application-id') || 
                                    actionBtn.closest('[data-application-id]')?.getAttribute('data-application-id');
                const application = applications.find(app => app.id.toString() === applicationId);
                
                if (application) {
                    handleQuickAction(action, application);
                }
            }
        });
    }
    
    // Function to update application status
    async function updateApplicationStatus(applicationId, status) {
        try {
            const response = await fetch(`/api/job-applications/${applicationId}/`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update application status');
            }
            
            // Show success message
            showToast('Status updated successfully', 'success');
            
        } catch (error) {
            console.error('Error updating application status:', error);
            showToast('Failed to update status. Please try again.', 'error');
        }
    }
    
    // Function to handle quick actions
    function handleQuickAction(action, application) {
        switch (action) {
            case 'email':
                window.location.href = `mailto:${application.applicant.email}?subject=Regarding Your Application for ${application.job.title}`;
                break;
                
            case 'schedule':
                // In a real app, this would open a scheduling modal
                showToast('Open scheduling calendar for ' + application.applicant.full_name, 'info');
                break;
                
            case 'reject':
                if (confirm(`Are you sure you want to reject ${application.applicant.full_name}'s application?`)) {
                    updateApplicationStatus(application.id, 'rejected');
                }
                break;
                
            default:
                console.log('Unknown action:', action);
        }
    }
    
    // Function to set up filtering and sorting
    function setupApplicantFilters(modal, applications) {
        const container = modal.querySelector('#applicantsContainer');
        const sortBtn = modal.querySelector('#sortByDateBtn');
        const statusFilters = modal.querySelectorAll('.status-filter');
        
        let sortOrder = 'desc'; // Default: newest first
        let currentStatusFilter = 'all';
        
        // Toggle sort order
        if (sortBtn) {
            sortBtn.addEventListener('click', function() {
                sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
                this.innerHTML = sortOrder === 'desc' 
                    ? '<i class="bi bi-sort-down"></i> Newest First'
                    : '<i class="bi bi-sort-up"></i> Oldest First';
                renderFilteredApplications();
            });
        }
        
        // Handle status filter clicks
        statusFilters.forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                const status = this.getAttribute('data-status');
                currentStatusFilter = status;
                
                // Update active state
                statusFilters.forEach(f => f.classList.remove('active'));
                this.classList.add('active');
                
                renderFilteredApplications();
            });
        });
        
        // Render applications based on current filters/sort
        function renderFilteredApplications() {
            let filtered = [...applications];
            
            // Apply status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(app => 
                    app.status.toLowerCase() === currentStatusFilter
                );
            }
            
            // Apply sort
            filtered.sort((a, b) => {
                const dateA = new Date(a.applied_at);
                const dateB = new Date(b.applied_at);
                return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            // Clear and re-render
            container.innerHTML = filtered.map(app => generateApplicantCard(app)).join('');
            
            // Update count
            const countElement = modal.querySelector('.applications-count');
            if (countElement) {
                countElement.textContent = `${filtered.length} ${filtered.length === 1 ? 'applicant' : 'applicants'}`;
                
                if (currentStatusFilter !== 'all') {
                    countElement.textContent += ` (${statusFilters.find(f => f.getAttribute('data-status') === currentStatusFilter)?.textContent})`;
                }
            }
        }
    }
    
    // Helper function to show toast notifications
    function showToast(message, type = 'info') {
        // In a real app, you'd use a toast library or custom toast component
        // This is a simple implementation that could be enhanced
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Auto-remove after delay
        setTimeout(() => {
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }, 100);
    }

    async function showApplicantsModal(jobId, jobTitle) {
        console.log('showApplicantsModal called with jobId:', jobId, 'jobTitle:', jobTitle);
        
        // Ensure modal elements exist
        if (!modal || !modalTitle) {
            console.error('Modal elements not found');
            showToast('Error initializing modal. Please refresh the page.', 'error');
            return;
        }
    
        try {
            // Update modal title
            modalTitle.textContent = `Applicants for ${jobTitle}`;
            
            // Get applicants list container
            const applicantsList = document.getElementById('applicantsList');
            if (!applicantsList) {
                console.error('Applicants list container not found');
                showToast('Error: Could not load applicants list', 'error');
                return;
            }
            applicantsList.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading applicants...</p>
                </div>`;
                
            // Show the modal before making the API call
            modal.style.display = 'block';
        
            // Check if user is authenticated
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.id) {
                applicantsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">error_outline</i>
                        <h3>Authentication Required</h3>
                        <p>Your session has expired. Please log in again to view applicants.</p>
                        <a href="login.html?redirect=${encodeURIComponent(window.location.pathname)}" class="btn btn-primary">
                            <i class="material-icons">login</i> Go to Login
                        </a>
                    </div>
                `;
                return;
            }
            
            // Initialize API service
            const api = window.TalentLink?.api || new ApiService();
            console.log('Calling getJobApplicants for jobId:', jobId);
            
            // Add a timestamp to prevent caching
            const timestamp = new Date().getTime();
            
            // Log the token being used (already retrieved above)
            console.log('Current token:', token ? 'Token exists' : 'No token found');
            
            // Make the API call with additional headers
            const response = await fetch(`http://localhost:8000/api/job-applications/job-applicants/${jobId}/?_=${timestamp}`, {
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',  // Important for including cookies/session
                redirect: 'manual'  // Handle redirects manually
            });
            
            console.log('API Response status:', response.status);
            
            // Handle unauthorized/redirect responses
            if (response.status === 401 || response.status === 302 || 
                (response.redirected && response.url.includes('login'))) {
                throw new Error('Your session has expired. Please log in again.');
            }
            
            // Handle other error statuses
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `Server returned ${response.status} status`);
            }
            
            // Check if the response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text.substring(0, 500));
                throw new Error('Received unexpected response format from server');
            }
            
            const data = await response.json();
            console.log('API Response data:', data);
            
            const applications = Array.isArray(data) ? data : (data?.applications || []);
            console.log('Processed applications:', applications);
            
            if (!applications.length) {
                console.log('No applications found for jobId:', jobId);
                applicantsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">people_outline</i>
                        <h3>No Applicants Yet</h3>
                        <p>No one has applied to this job yet.</p>
                        <button class="btn btn-primary" onclick="modal.style.display='none'">
                            <i class="material-icons">close</i> Close
                        </button>
                    </div>
                `;
                return;
            }
            
            applicantsList.innerHTML = `
                <div class="applicants-grid">
                    ${applications.map(application => {
                        const appliedDate = new Date(application.applied_at);
                        const applicant = application.applicant_details || {};
                        const statusClass = `status-${application.status}`;
                        
                        return `
                            <div class="applicant-card">
                                <!-- Header Section -->
                                <div class="applicant-header">
                                    <div class="applicant-avatar">
                                        <span class="avatar-initials">
                                            ${(applicant.first_name?.charAt(0) || '') + (applicant.last_name?.charAt(0) || 'U')}
                                        </span>
                                    </div>
                                    <div class="applicant-info">
                                        <div class="applicant-name-row">
                                            <h4 class="applicant-name">
                                                ${applicant.first_name || ''} ${applicant.last_name || 'Applicant'}
                                                <span class="applicant-status ${statusClass}">
                                                    ${application.status.replace('_', ' ')}
                                                </span>
                                            </h4>
                                            <div class="applicant-meta">
                                                <span class="meta-item" title="Application ID">
                                                    <i class="material-icons">assignment</i>
                                                    ID: ${application.id}
                                                </span>
                                                <span class="meta-item" title="Time since application">
                                                    <i class="material-icons">schedule</i>
                                                    ${getTimeAgo(appliedDate)}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="applicant-contact">
                                            ${applicant.email ? `
                                            <a href="mailto:${applicant.email}" class="contact-item" title="Email">
                                                <i class="material-icons">email</i>
                                                ${applicant.email}
                                            </a>` : ''}
                                            ${applicant.phone_number ? `
                                            <a href="tel:${applicant.phone_number}" class="contact-item" title="Phone">
                                                <i class="material-icons">phone</i>
                                                ${applicant.phone_number}
                                            </a>` : ''}
                                            ${applicant.location ? `
                                            <span class="contact-item">
                                                <i class="material-icons">location_on</i>
                                                ${applicant.location}
                                            </span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Main Content -->
                                <div class="applicant-content">
                                    <!-- Left Column -->
                                    <div class="applicant-details">
                                        <!-- Application Info Card -->
                                        <div class="info-card">
                                            <h5 class="info-card-title">
                                                <i class="material-icons">event</i>
                                                Application Details
                                            </h5>
                                            <div class="info-card-content">
                                                <div class="info-row">
                                                    <span class="info-label">Applied On</span>
                                                    <span class="info-value">
                                                        ${appliedDate.toLocaleDateString('en-US', { 
                                                            year: 'numeric', 
                                                            month: 'short', 
                                                            day: 'numeric'
                                                        })}
                                                        <small>${appliedDate.toLocaleTimeString('en-US', {
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}</small>
                                                    </span>
                                                </div>
                                                <div class="info-row">
                                                    <span class="info-label">User Type</span>
                                                    <span class="info-value">
                                                        <i class="material-icons">person</i>
                                                        ${applicant.user_type?.replace('_', ' ') || 'Candidate'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Skills Card -->
                                        ${application.skills ? `
                                        <div class="info-card">
                                            <h5 class="info-card-title">
                                                <i class="material-icons">psychology</i>
                                                Skills & Expertise
                                            </h5>
                                            <div class="info-card-content">
                                                <div class="skills-container">
                                                    ${application.skills.split(',').map(skill => 
                                                        `<span class="skill-tag">${skill.trim()}</span>`
                                                    ).join('')}
                                                </div>
                                            </div>
                                        </div>` : ''}
                                    </div>
                                    
                                    <!-- Right Column -->
                                    <div class="applicant-actions">
                                        <!-- Resume Section -->
                                        <div class="action-card">
                                            <h5 class="action-card-title">
                                                <i class="material-icons">description</i>
                                                Resume
                                            </h5>
                                            ${application.resume_url ? `
                                            <a href="${application.resume_url}" target="_blank" class="btn btn-primary btn-block">
                                                <i class="material-icons">visibility</i>
                                                View Resume
                                            </a>` : 
                                            '<div class="no-resume">No resume uploaded</div>'}
                                        </div>
                                        
                                        <!-- Quick Actions -->
                                        <div class="action-card">
                                            <h5 class="action-card-title">
                                                <i class="material-icons">bolt</i>
                                                Quick Actions
                                            </h5>
                                            <div class="action-buttons">
                                                <button class="btn btn-outline btn-block" data-action="email" data-email="${applicant.email || ''}">
                                                    <i class="material-icons">email</i>
                                                    Send Email
                                                </button>
                                                ${applicant.phone_number ? `
                                                <a href="tel:${applicant.phone_number}" class="btn btn-outline btn-block">
                                                    <i class="material-icons">call</i>
                                                    Call Candidate
                                                </a>` : ''}
                                                <button class="btn btn-outline btn-block text-danger" data-action="reject">
                                                    <i class="material-icons">close</i>
                                                    Reject Application
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Status Update -->
                                        <div class="action-card">
                                            <h5 class="action-card-title">
                                                <i class="material-icons">update</i>
                                                Update Status
                                            </h5>
                                            <div class="status-options">
                                                <button class="status-option ${application.status === 'applied' ? 'active' : ''}" data-status="applied">
                                                    <i class="material-icons">schedule</i>
                                                    <span>Applied</span>
                                                </button>
                                                <button class="status-option ${application.status === 'under_review' ? 'active' : ''}" data-status="under_review">
                                                    <i class="material-icons">visibility</i>
                                                    <span>Review</span>
                                                </button>
                                                <button class="status-option ${application.status === 'interview' ? 'active' : ''}" data-status="interview">
                                                    <i class="material-icons">event_available</i>
                                                    <span>Interview</span>
                                                </button>
                                                <button class="status-option ${application.status === 'accepted' ? 'active' : ''} status-accept" data-status="accepted">
                                                    <i class="material-icons">check_circle</i>
                                                    <span>Hire</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cover Letter Section -->
                                ${application.cover_letter ? `
                                <div class="cover-letter-section">
                                    <div class="section-header">
                                        <i class="material-icons">description</i>
                                        <h5>Cover Letter</h5>
                                    </div>
                                    <div class="cover-letter-content">
                                        ${application.cover_letter}
                                    </div>
                                </div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Add helper functions
            function getStatusIcon(status) {
                const icons = {
                    'applied': 'schedule',
                    'under_review': 'visibility',
                    'interview': 'event',
                    'accepted': 'check_circle',
                    'rejected': 'cancel'
                };
                return icons[status] || 'schedule';
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
                return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
            }
            
        } catch (err) {
            console.error('Error loading applicants:', err);
            let errorMessage = 'Failed to load applicants. ';
            
            if (err.message.includes('HTML response') || err.status === 401 || err.message.includes('session')) {
                errorMessage = 'Your session has expired. Please log in again.';
                // Clear existing auth data
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            } else if (err.status === 403) {
                errorMessage = 'You do not have permission to view these applicants.';
            } else if (err.status === 404) {
                errorMessage = 'The requested job was not found.';
            } else if (err.message.includes('non-JSON')) {
                errorMessage = 'Server returned an unexpected response. Please try again.';
            } else {
                errorMessage = 'Please try again later.';
            }
            
            // Create a more detailed error message for debugging
            const debugInfo = `
                Error: ${err.message || 'Unknown error'}
                Status: ${err.status || 'N/A'}
                Time: ${new Date().toISOString()}
            `;
            
            console.error('Debug Info:', debugInfo);
            
            applicantsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">error_outline</i>
                    <h3>Error Loading Applicants</h3>
                    <p>${errorMessage}</p>
                    <p><small>${err.message || ''}</small></p>
                    <div style="margin-top: 20px;">
                        <a href="login.html?redirect=${encodeURIComponent(window.location.pathname)}" class="btn btn-primary" style="margin-right: 10px;">
                            <i class="material-icons">login</i> Log In Again
                        </a>
                        <button onclick="location.reload()" class="btn btn-outline">
                            <i class="material-icons">refresh</i> Refresh Page
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #666;">
                        <div><strong>Debug Info:</strong></div>
                        <div>${debugInfo.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        }
    }
    </script>
</body>
</html> 