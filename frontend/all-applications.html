<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Applications - TalentLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .applications-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        .applications-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .applications-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }
        .applications-header p {
            font-size: 1.1rem;
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }
        .application-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .application-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1.5rem;
        }
        .application-info {
            flex: 1;
        }
        .job-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .job-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }
        .job-title a:hover {
            color: #1976d2;
        }
        .company-name {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .application-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        .meta-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background-color: #f8f9fa;
            color: #495057;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .meta-tag i {
            font-size: 1rem;
            color: #6c757d;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status-badge i {
            font-size: 1rem;
        }
        .application-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        .btn-view-applicants {
            background: linear-gradient(135deg, #4a6cf7 0%, #3b5bdb 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 108, 247, 0.25);
            position: relative;
            overflow: hidden;
            min-width: 160px;
            justify-content: center;
        }
        .btn-view-applicants .material-icons {
            color: white;
        }
        .btn-view-applicants:hover {
            background: linear-gradient(135deg, #3b5bdb 0%, #274bb6 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(74, 108, 247, 0.35);
            color: white;
        }
        .btn-view-applicants:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(74, 108, 247, 0.25);
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .empty-state .material-icons {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .empty-state h3 {
            font-size: 1.5rem;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }
        .empty-state p {
            color: #6c757d;
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6cf7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .application-header { flex-direction: column; align-items: flex-start; }
            .status-badge { align-self: flex-start; }
            .application-meta { flex-direction: column; gap: 0.5rem; }
            .meta-tag { width: fit-content; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">TalentLink</a>
            <div class="nav-links" id="navLinks">
                <a href="index.html">Home</a>
                <a href="jobs.html">Jobs</a>
                <a href="#companies">Companies</a>
                <a href="all-applications.html" id="applicationsLink" class="active">Applications</a>
                <a href="post-job.html" class="btn btn-primary" id="postJobBtn" style="margin-left: 10px;">
                    <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</i>
                    Post a Job
                </a>
                <div id="authState"></div>
            </div>
            <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false" aria-controls="navLinks">
                <span class="material-icons">menu</span>
            </button>
        </div>
    </nav>
    <main class="container" style="margin-top: 6rem;">
        <div class="applications-container">
            <div class="applications-header">
                <h1>All Applications</h1>
                <p>View all jobs posted by your company and see how many candidates have applied.</p>
            </div>
            <div id="applicationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your posted jobs...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Applicants Modal -->
    <div id="applicantsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Applicants</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="applicantsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading applicants...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-radius: 12px 12px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            color: #1a1a1a;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }
        .close:hover {
            color: #666;
        }
        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Enhanced Applicant Cards */
        .applicants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .applicant-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .applicant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .applicant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #4a6cf7 0%, #3b5bdb 100%);
        }
        
        .applicant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        
        .applicant-info {
            flex: 1;
        }
        
        .applicant-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .applicant-name .material-icons {
            color: #4a6cf7;
            font-size: 1.2rem;
        }
        
        .applicant-contact {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .contact-item .material-icons {
            font-size: 1rem;
            color: #4a6cf7;
        }
        
        .applicant-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .status-applied { 
            background-color: #e3f2fd; 
            color: #1976d2; 
        }
        .status-under_review { 
            background-color: #fff3e0; 
            color: #f57c00; 
        }
        .status-interview { 
            background-color: #e8f5e9; 
            color: #388e3c; 
        }
        .status-accepted { 
            background-color: #e8f5e8; 
            color: #2e7d32; 
        }
        .status-rejected { 
            background-color: #ffebee; 
            color: #d32f2f; 
        }
        
        .applicant-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-item .material-icons {
            color: #4a6cf7;
            font-size: 1.1rem;
            margin-top: 0.1rem;
        }
        
        .detail-content {
            flex: 1;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            color: #1a1a1a;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .cover-letter-section {
            margin-bottom: 1.5rem;
        }
        
        .cover-letter {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #4a6cf7;
        }
        
        .cover-letter .detail-label {
            margin-bottom: 0.5rem;
        }
        
        .cover-letter .detail-value {
            font-style: italic;
            line-height: 1.6;
        }
        
        .applicant-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        .btn-download-resume {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
        }
        
        .btn-download-resume:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
            color: white;
        }
        
        .no-resume {
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .applicant-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
            
            .modal-header {
                padding: 1rem 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            
            .applicants-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .applicant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .applicant-details {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .applicant-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .btn-download-resume {
                justify-content: center;
            }
        }
    </style>
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3>TalentLink</h3>
                    <p>Connecting top talent with leading companies worldwide. Find your dream job or your next great hire today.</p>
                </div>
                <div class="footer-links">
                    <h4>For Job Seekers</h4>
                    <a href="jobs.html">Browse Jobs</a>
                    <a href="profile.html">Create Profile</a>
                    <a href="#">Career Resources</a>
                </div>
                <div class="footer-links">
                    <h4>For Employers</h4>
                    <a href="post-job.html">Post a Job</a>
                    <a href="#">Browse Candidates</a>
                    <a href="#">Pricing</a>
                </div>
                <div class="footer-links">
                    <h4>Company</h4>
                    <a href="#">About Us</a>
                    <a href="#">Contact</a>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TalentLink. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM fully loaded, initializing application...');
        
        // Initialize API service
        const api = window.TalentLink?.api || new ApiService();
        if (window.TalentLink) {
            window.TalentLink.api = api;
        }
        
        // Get token and user info
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const applicationsList = document.getElementById('applicationsList');
        
        // Debug info
        console.log('Debug - Token exists:', !!token);
        console.log('Debug - User object:', user);
        console.log('Debug - API Service available:', !!api);
        
        // Check authentication and role
        if (!token || !user.id) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">lock</i>
                    <h3>Authentication Required</h3>
                    <p>You need to be logged in to view this page.</p>
                    <a href="login.html" class="btn btn-primary">Login</a>
                </div>
            `;
            return;
        }
        
        // Check if user is an employer
        if (!(user.user_type === 'company' || user.user_type === 'employer')) {
            applicationsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">block</i>
                    <h3>Access Denied</h3>
                    <p>This page is only accessible to employers.</p>
                    <a href="index.html" class="btn btn-primary">Return to Home</a>
                </div>
            `;
            return;
        }
        
        // Set the token for API calls
        api.setToken(token);
        
        // Add a small delay to ensure everything is properly initialized
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            console.log('Debug - Loading employer jobs...');
            
            // Use the backend endpoint that works based on the logged-in user
            const jobsResponse = await api.jobs.getMyCompanyJobs();
            console.log('Debug - API Response:', jobsResponse);
            
            const jobs = jobsResponse.results || [];
            console.log('Debug - Jobs loaded:', jobs);
            
            if (!jobs || jobs.length === 0) {
                applicationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">work_outline</i>
                        <h3>No Jobs Posted Yet</h3>
                        <p>You haven't posted any jobs yet. Start by posting a new job to see applications here.</p>
                        <a href="post-job.html" class="btn btn-primary">Post a Job</a>
                    </div>
                `;
                return;
            }
            
            applicationsList.innerHTML = jobs.map(job => `
                <div class="application-card">
                    <div class="application-header">
                        <div class="application-info">
                            <h3 class="job-title">
                                <a href="job-details.html?id=${job.id}">${job.title}</a>
                            </h3>
                            <div class="company-name">
                                <i class="material-icons">business</i>
                                ${job.company_name || 'Company'}
                            </div>
                            <div class="application-meta">
                                <span class="meta-tag">
                                    <i class="material-icons">event</i>
                                    Posted: ${new Date(job.created_at).toLocaleDateString()}
                                </span>
                                <span class="meta-tag">
                                    <i class="material-icons">work</i>
                                    ${job.job_type}
                                </span>
                            </div>
                        </div>
                        <div class="status-badge">
                            <i class="material-icons">group</i>
                            ${job.applicant_count} Applicants
                        </div>
                    </div>
                    <div class="application-actions">
                        <button class="btn btn-primary btn-view-applicants" data-job-id="${job.id}" data-job-title="${job.title}">
                            <i class="material-icons">visibility</i> View Applicants
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners for 'View Applicants' buttons
            document.querySelectorAll('.btn-view-applicants').forEach(button => {
                button.addEventListener('click', async function() {
                    const jobId = this.getAttribute('data-job-id');
                    const jobTitle = this.getAttribute('data-job-title');
                    await showApplicantsModal(jobId, jobTitle);
                });
            });
        } catch (error) {
            console.error('Error loading jobs:', error);
            applicationsList.innerHTML = `<div class="empty-state"><i class="material-icons">error</i><h3>Error</h3><p>Could not load your jobs. Error: ${error.message}</p></div>`;
        }
    });

    // Modal functionality
    const modal = document.getElementById('applicantsModal');
    const modalTitle = document.getElementById('modalTitle');
    const applicantsList = document.getElementById('applicantsList');
    const closeBtn = document.querySelector('.close');

    // Close modal when clicking the X
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    async function showApplicantsModal(jobId, jobTitle) {
        console.log('showApplicantsModal called with jobId:', jobId, 'jobTitle:', jobTitle);
        modalTitle.textContent = `Applicants for ${jobTitle}`;
        modal.style.display = "block";
        
        // Check if user is authenticated using the same method as page load
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token || !user.id) {
            applicantsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">error_outline</i>
                    <h3>Authentication Required</h3>
                    <p>Your session has expired. Please log in again to view applicants.</p>
                    <a href="login.html?redirect=${encodeURIComponent(window.location.pathname)}" class="btn btn-primary">
                        <i class="material-icons">login</i> Go to Login
                    </a>
                </div>
            `;
            return;
        }
        
        applicantsList.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading applicants...</p>
            </div>
        `;
        
        try {
            const api = window.TalentLink?.api || new ApiService();
            console.log('Calling getJobApplicants for jobId:', jobId);
            
            // Add a timestamp to prevent caching
            const timestamp = new Date().getTime();
            
            // Log the token being used
            const token = localStorage.getItem('token');
            console.log('Current token:', token ? 'Token exists' : 'No token found');
            
            // Make the API call with additional headers
            const response = await fetch(`http://localhost:8000/api/job-applications/job-applicants/${jobId}/?_=${timestamp}`, {
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include'  // Important for including cookies/session
            });
            
            console.log('API Response status:', response.status);
            
            // Check if we got redirected to login
            if (response.redirected && response.url.includes('login')) {
                throw new Error('Redirected to login page. Your session may have expired.');
            }
            
            // Check if the response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text.substring(0, 500)); // Log first 500 chars
                throw new Error('Server returned non-JSON response');
            }
            
            const data = await response.json();
            console.log('API Response data:', data);
            
            const applications = Array.isArray(data) ? data : (data?.applications || []);
            console.log('Processed applications:', applications);
            
            if (applications.length === 0) {
                console.log('No applications found for jobId:', jobId);
                applicantsList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">people_outline</i>
                        <h3>No Applicants Yet</h3>
                        <p>No one has applied to this job yet.</p>
                    </div>
                `;
                return;
            }
            
            applicantsList.innerHTML = `
                <div class="applicants-grid">
                    ${applications.map(application => {
                        const appliedDate = new Date(application.applied_at);
                        const applicant = application.applicant_details || {};
                        const statusClass = `status-${application.status}`;
                        
                        return `
                            <div class="applicant-card">
                                <div class="applicant-header">
                                    <div class="applicant-info">
                                        <div class="applicant-name">
                                            <i class="material-icons">person</i>
                                            ${applicant.first_name || ''} ${applicant.last_name || ''}
                                        </div>
                                        <div class="applicant-contact">
                                            <div class="contact-item">
                                                <i class="material-icons">email</i>
                                                ${applicant.email || 'No email provided'}
                                            </div>
                                            ${applicant.phone_number ? `
                                            <div class="contact-item">
                                                <i class="material-icons">phone</i>
                                                ${applicant.phone_number}
                                            </div>` : ''}
                                        </div>
                                    </div>
                                    <div class="applicant-status ${statusClass}">
                                        <i class="material-icons">${getStatusIcon(application.status)}</i>
                                        ${application.status.replace('_', ' ')}
                                    </div>
                                </div>
                                
                                <div class="applicant-details">
                                    <div class="detail-item">
                                        <i class="material-icons">event</i>
                                        <div class="detail-content">
                                            <div class="detail-label">Applied On</div>
                                            <div class="detail-value">${appliedDate.toLocaleDateString('en-US', { 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}</div>
                                        </div>
                                    </div>
                                    ${application.skills ? `
                                    <div class="detail-item">
                                        <i class="material-icons">psychology</i>
                                        <div class="detail-content">
                                            <div class="detail-label">Skills</div>
                                            <div class="detail-value">${application.skills}</div>
                                        </div>
                                    </div>` : ''}
                                    ${applicant.location ? `
                                    <div class="detail-item">
                                        <i class="material-icons">location_on</i>
                                        <div class="detail-content">
                                            <div class="detail-label">Location</div>
                                            <div class="detail-value">${applicant.location}</div>
                                        </div>
                                    </div>` : ''}
                                    <div class="detail-item">
                                        <i class="material-icons">work</i>
                                        <div class="detail-content">
                                            <div class="detail-label">User Type</div>
                                            <div class="detail-value">${applicant.user_type || 'Candidate'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${application.cover_letter ? `
                                <div class="cover-letter-section">
                                    <div class="cover-letter">
                                        <div class="detail-label">Cover Letter</div>
                                        <div class="detail-value">${application.cover_letter}</div>
                                    </div>
                                </div>` : ''}
                                
                                <div class="applicant-actions">
                                    <div class="applicant-meta">
                                        <div class="meta-item">
                                            <i class="material-icons">schedule</i>
                                            Applied ${getTimeAgo(appliedDate)}
                                        </div>
                                        <div class="meta-item">
                                            <i class="material-icons">assignment</i>
                                            ID: ${application.id}
                                        </div>
                                    </div>
                                    ${application.resume_url ? `
                                    <a href="${application.resume_url}" target="_blank" class="btn-download-resume">
                                        <i class="material-icons">download</i>
                                        View Resume
                                    </a>` : 
                                    '<span class="no-resume">No resume uploaded</span>'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Add helper functions
            function getStatusIcon(status) {
                const icons = {
                    'applied': 'schedule',
                    'under_review': 'visibility',
                    'interview': 'event',
                    'accepted': 'check_circle',
                    'rejected': 'cancel'
                };
                return icons[status] || 'schedule';
            }
            
            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
                return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
            }
            
        } catch (err) {
            console.error('Error loading applicants:', err);
            let errorMessage = 'Failed to load applicants. ';
            
            if (err.message.includes('HTML response') || err.status === 401 || err.message.includes('session')) {
                errorMessage = 'Your session has expired. Please log in again.';
                // Clear existing auth data
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            } else if (err.status === 403) {
                errorMessage = 'You do not have permission to view these applicants.';
            } else if (err.status === 404) {
                errorMessage = 'The requested job was not found.';
            } else if (err.message.includes('non-JSON')) {
                errorMessage = 'Server returned an unexpected response. Please try again.';
            } else {
                errorMessage = 'Please try again later.';
            }
            
            // Create a more detailed error message for debugging
            const debugInfo = `
                Error: ${err.message || 'Unknown error'}
                Status: ${err.status || 'N/A'}
                Time: ${new Date().toISOString()}
            `;
            
            console.error('Debug Info:', debugInfo);
            
            applicantsList.innerHTML = `
                <div class="empty-state">
                    <i class="material-icons">error_outline</i>
                    <h3>Error Loading Applicants</h3>
                    <p>${errorMessage}</p>
                    <p><small>${err.message || ''}</small></p>
                    <div style="margin-top: 20px;">
                        <a href="login.html?redirect=${encodeURIComponent(window.location.pathname)}" class="btn btn-primary" style="margin-right: 10px;">
                            <i class="material-icons">login</i> Log In Again
                        </a>
                        <button onclick="location.reload()" class="btn btn-outline">
                            <i class="material-icons">refresh</i> Refresh Page
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #666;">
                        <div><strong>Debug Info:</strong></div>
                        <div>${debugInfo.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        }
    }
    </script>
</body>
</html> 