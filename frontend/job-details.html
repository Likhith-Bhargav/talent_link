<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Details - TalentLink</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/job-details.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">TalentLink</a>
            <div class="nav-links" id="navLinks">
                <a href="index.html">Home</a>
                <a href="jobs.html">Jobs</a>
                <a href="#companies">Companies</a>
                <a href="my-applications.html" id="applicationsLink">Your Applications</a>
                <!-- Post a Job Button - Only visible to employers -->
                <a href="post-job.html" class="btn btn-primary" id="postJobBtn">
                    <i class="material-icons">add</i>
                    Post a Job
                </a>
                <!-- Auth State Container - Will be managed by auth.js -->
                <div id="authState">
                    <!-- Login/Signup Buttons (Shown when not logged in) -->
                    <div class="auth-buttons" id="authButtons">
                        <a href="login.html" class="btn btn-outline" id="loginLink">Login</a>
                        <a href="signup.html" class="btn btn-primary" id="registerLink">Sign Up</a>
                    </div>
                    <!-- User Menu (Shown when logged in) -->
                    <div class="user-menu" id="userMenu">
                        <div class="user-dropdown">
                            <button class="user-avatar" id="userAvatar">
                                <span class="material-icons">account_circle</span>
                                <span id="userInitials" class="user-initials"></span>
                            </button>
                            <div class="dropdown-content" id="dropdownMenu">
                                <div class="user-info">
                                    <div id="userName" class="user-name">Loading...</div>
                                    <div id="userEmail" class="user-email"></div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <a href="profile.html"><i class="material-icons">person</i> My Profile</a>
                                <a href="my-jobs.html"><i class="material-icons">work</i> My Jobs</a>
                                <a href="settings.html"><i class="material-icons">settings</i> Settings</a>
                                <div class="dropdown-divider"></div>
                                <a href="#" id="logoutBtn"><i class="material-icons">logout</i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="hamburger" id="hamburger">
                <span class="material-icons">menu</span>
            </button>
        </div>
    </nav>

    <!-- Job Details Section -->
    <main class="container" style="margin-top: 6rem;">
        <div style="margin-top: 2.5rem; margin-bottom: 1.5rem;">
            <button onclick="window.history.back()" class="btn btn-outline">
                <i class="material-icons">arrow_back</i> Back
            </button>
        </div>
        <div id="jobDetails" class="job-details-card loading">
            <div class="spinner"></div>
            <p>Loading job details...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3>TalentLink</h3>
                    <p>Connecting top talent with leading companies worldwide. Find your dream job or your next great hire today.</p>
                </div>
                <div class="footer-links">
                    <h4>For Job Seekers</h4>
                    <a href="#">Browse Jobs</a>
                    <a href="#">Create Profile</a>
                    <a href="#">Career Resources</a>
                </div>
                <div class="footer-links">
                    <h4>For Employers</h4>
                    <a href="#">Post a Job</a>
                    <a href="#">Browse Candidates</a>
                    <a href="#">Pricing</a>
                </div>
                <div class="footer-contact">
                    <h4>Contact Us</h4>
                    <p>Email: info@talentlink.com</p>
                    <p>Phone: (123) 456-7890</p>
                    <div class="social-links">
                        <a href="#" aria-label="Facebook">FB</a>
                        <a href="#" aria-label="Twitter">TW</a>
                        <a href="#" aria-label="LinkedIn">IN</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TalentLink. All rights reserved.</p>
                <div class="legal-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Update applications link text based on user type
        function updateApplicationsLink() {
            const applicationsLink = document.getElementById('applicationsLink');
            if (applicationsLink && window.TalentLink?.auth) {
                const isEmployer = window.TalentLink.auth.isEmployer();
                applicationsLink.textContent = isEmployer ? 'Applications' : 'My Applications';
            }
        }
        
        // Update on auth state change
        window.addEventListener('authStateChange', updateApplicationsLink);
        
        // Initial update
        setTimeout(updateApplicationsLink, 100);
        
        const api = window.TalentLink && window.TalentLink.api;
        const jobDetailsDiv = document.getElementById('jobDetails');
        // Get job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('id');
        if (!jobId) {
            jobDetailsDiv.innerHTML = '<div class="error-message"><i class="material-icons">error_outline</i> <p>Job not found.</p></div>';
            return;
        }
        try {
            const job = await api.jobs.getById(jobId);
            jobDetailsDiv.classList.remove('loading');
            let applyButton = '';
            let user = null;
            try {
              user = JSON.parse(localStorage.getItem('user'));
            } catch (e) {}
            let alreadyApplied = false;
            if (user && (user.user_type === 'candidate' || user.user_type === 'job_seeker' || user.is_candidate)) {
              // Check if user already applied
              let myApplications = [];
              try {
                myApplications = await api.jobs.getMyApplications();
                // Normalize to array
                if (!Array.isArray(myApplications)) {
                  if (myApplications && myApplications.results && Array.isArray(myApplications.results)) {
                    myApplications = myApplications.results;
                  } else if (myApplications && myApplications.data && Array.isArray(myApplications.data)) {
                    myApplications = myApplications.data;
                  } else {
                    myApplications = [];
                  }
                }
                alreadyApplied = myApplications.some(app => String(app.job_posting) === String(job.id));
              } catch (e) {
                console.warn('Could not load user applications:', e);
              }
              if (alreadyApplied) {
                applyButton = `
                  <button class="btn-apply" id="applyNowBtn" data-job-id="${job.id}" disabled style="background:#bdbdbd;cursor:not-allowed;">
                    <i class="material-icons">check_circle</i> Applied
                  </button>
                `;
              } else {
                applyButton = `
                  <button class="btn-apply" id="applyNowBtn" data-job-id="${job.id}">
                    <i class="material-icons">send</i> Apply Now
                  </button>
                `;
              }
              // Function to handle apply button click
              const handleApplyClick = (jobId) => {
                // Check if user is logged in
                let user = null;
                try {
                  const userData = localStorage.getItem('user');
                  if (userData) user = JSON.parse(userData);
                } catch (e) {}
                if (!user || !user.id) {
                  // Redirect to login with return URL
                  window.location.href = 'login.html?redirect=' + encodeURIComponent('application.html?jobId=' + jobId);
                  return;
                }
                // Redirect to application page
                window.location.href = 'application.html?jobId=' + jobId;
              };

              // Add click handler for Apply Now button after the content is loaded
              setTimeout(() => {
                // Handle header apply button
                const headerApplyBtn = document.getElementById('applyNowTop');
                if (headerApplyBtn && !headerApplyBtn.disabled) {
                  headerApplyBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const jobId = headerApplyBtn.getAttribute('data-job-id');
                    handleApplyClick(jobId);
                  });
                }
                
                // Handle bottom apply button
                const bottomApplyBtn = document.getElementById('applyNowBtn');
                if (bottomApplyBtn && !bottomApplyBtn.disabled) {
                  bottomApplyBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const jobId = bottomApplyBtn.getAttribute('data-job-id');
                    handleApplyClick(jobId);
                  });
                }
              }, 100);
            }
            // Format date
            const postedDate = job.created_at ? new Date(job.created_at) : new Date();
            const formattedDate = postedDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            // Format salary if available
            const formatSalary = (salary) => {
              if (!salary) return 'Not specified';
              if (typeof salary === 'number') {
                return new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: 'USD',
                  maximumFractionDigits: 0
                }).format(salary);
              }
              return salary;
            };

            jobDetailsDiv.innerHTML = `
              <div class="job-header">
                <div class="company-logo">
                  ${job.company_name ? job.company_name.charAt(0).toUpperCase() : '?'}
                </div>
                <div class="job-header-content">
                  ${alreadyApplied ? `
                    <button class="apply-now-btn applied" id="applyNowTop" data-job-id="${job.id}" disabled>
                      <i class="material-icons">check_circle</i>
                      <span>Applied</span>
                    </button>
                  ` : `
                    <button class="apply-now-btn" id="applyNowTop" data-job-id="${job.id}">
                      <i class="material-icons">send</i>
                      <span>Apply Now</span>
                    </button>
                  `}
                  <h1 class="job-title">${job.title}</h1>
                  <div class="company-name">
                    <i class="material-icons">business</i>
                    ${job.company_name || 'Company not specified'}
                  </div>
                  
                  <div class="job-meta">
                    <div class="meta-item">
                      <i class="material-icons">location_on</i>
                      <span>${job.location || 'Location not specified'}</span>
                    </div>
                    <div class="meta-item">
                      <i class="material-icons">attach_money</i>
                      <span>${formatSalary(job.salary)}</span>
                    </div>
                    <div class="meta-item">
                      <i class="material-icons">work_outline</i>
                      <span>${job.job_type || 'Not specified'}</span>
                    </div>
                    <div class="meta-item">
                      <i class="material-icons">update</i>
                      <span>${formattedDate}</span>
                    </div>
                    ${job.application_deadline ? `
                      <div class="meta-item">
                        <i class="material-icons">event_busy</i>
                        <span>Apply by ${new Date(job.application_deadline).toLocaleDateString()}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <div class="job-content">
                <section class="job-section">
                  <h2 class="section-title">📋 Job Description</h2>
                  <div class="job-description">
                    ${job.description 
                      ? job.description.split('\n').filter(Boolean).map(para => `<p>${para}</p>`).join('')
                      : '<p>No job description provided.</p>'}
                  </div>
                </section>

                ${job.requirements ? `
                  <section class="job-section">
                    <h2 class="section-title">✅ Requirements</h2>
                    <div class="job-requirements">
                      ${job.requirements.split('\n').filter(Boolean).map(req => `<p>${req}</p>`).join('')}
                    </div>
                  </section>
                ` : ''}

                <section class="job-section">
                  <h2 class="section-title">🛠️ Skills & Qualifications</h2>
                  <div class="job-skills">
                    ${(job.skills && job.skills.length > 0) 
                      ? job.skills.map(skill => `
                          <span class="skill-tag">
                            <i class="material-icons">check_circle</i>
                            ${skill}
                          </span>`).join('') 
                      : `<div class="no-data">
                          <i class="material-icons">info</i>
                          <p>No specific skills listed for this position.</p>
                        </div>`}
                  </div>
                </section>

                ${job.benefits ? `
                  <section class="job-section">
                    <h2 class="section-title">Benefits</h2>
                    <div class="job-benefits">
                      ${job.benefits.replace(/\n/g, '<br>')}
                    </div>
                  </section>
                ` : ''}

                <div class="job-actions">
                  ${applyButton || ''}
                  <button class="btn btn-outline">
                    <i class="material-icons">bookmark_border</i>
                    Save Job
                  </button>
                </div>
              </div>

              <div class="job-sidebar">
                <div class="company-card">
                  <h3>About the Company</h3>
                  <div class="company-info">
                    <div class="company-logo">
                      ${job.company_name ? job.company_name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <h4>${job.company_name || 'Company'}</h4>
                    ${job.company_description ? `
                      <p class="company-description">
                        ${job.company_description.substring(0, 200)}${job.company_description.length > 200 ? '...' : ''}
                      </p>
                    ` : ''}
                    <a href="#" class="btn btn-text">View Company Profile</a>
                  </div>
                </div>

                <div class="similar-jobs">
                  <h3>Similar Jobs</h3>
                  <div class="similar-jobs-list">
                    <!-- Similar jobs will be loaded here -->
                    <div class="no-data">No similar jobs found</div>
                  </div>
                </div>
              </div>
            `;
        } catch (error) {
            jobDetailsDiv.innerHTML = `<div class="error-message"><i class="material-icons">error_outline</i> <p>Failed to load job details.</p></div>`;
        }
    });
    </script>
</body>
</html> 